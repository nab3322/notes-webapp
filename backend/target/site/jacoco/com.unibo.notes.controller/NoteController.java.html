<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="it"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>NoteController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Notes WebApp Backend</a> &gt; <a href="index.source.html" class="el_package">com.unibo.notes.controller</a> &gt; <span class="el_source">NoteController.java</span></div><h1>NoteController.java</h1><pre class="source lang-java linenums">package com.unibo.notes.controller;

import com.unibo.notes.dto.CreateNoteRequest;
import com.unibo.notes.dto.NoteDTO;
import com.unibo.notes.dto.NoteVersionDTO;
import com.unibo.notes.dto.UpdateNoteRequest;
import com.unibo.notes.entity.Note;
import com.unibo.notes.service.NoteService;
import com.unibo.notes.service.VersionService;
import io.smallrye.jwt.auth.principal.JWTCallerPrincipal;
import jakarta.inject.Inject;
import jakarta.validation.Valid;
import jakarta.ws.rs.*;
import jakarta.ws.rs.core.Context;
import jakarta.ws.rs.core.MediaType;
import jakarta.ws.rs.core.Response;
import jakarta.ws.rs.core.SecurityContext;

import java.util.List;
import java.util.stream.Collectors;

@Path(&quot;/api/notes&quot;)
@Produces(MediaType.APPLICATION_JSON)
@Consumes(MediaType.APPLICATION_JSON)
<span class="nc" id="L25">public class NoteController {</span>

    @Inject
    NoteService noteService;

    @Inject
    VersionService versionService;

    private Long getUserId(SecurityContext securityContext) {
<span class="nc bnc" id="L34" title="All 2 branches missed.">        if (securityContext.getUserPrincipal() == null) {</span>
<span class="nc" id="L35">            throw new SecurityException(&quot;No authentication token&quot;);</span>
        }
<span class="nc" id="L37">        JWTCallerPrincipal principal = (JWTCallerPrincipal) securityContext.getUserPrincipal();</span>
<span class="nc" id="L38">        return Long.parseLong(principal.getSubject());</span>
    }

    @GET
    public Response getAllNotes(@Context SecurityContext securityContext) {
<span class="nc" id="L43">        Long userId = getUserId(securityContext);</span>
<span class="nc" id="L44">        List&lt;Note&gt; notes = noteService.getAllNotesByUser(userId);</span>
<span class="nc" id="L45">        List&lt;NoteDTO&gt; noteDTOs = notes.stream().map(this::toDTO).collect(Collectors.toList());</span>
<span class="nc" id="L46">        return Response.ok(noteDTOs).build();</span>
    }

    @GET
    @Path(&quot;/{noteId}&quot;)
    public Response getNoteById(@PathParam(&quot;noteId&quot;) Long noteId,
                                @Context SecurityContext securityContext) {
<span class="nc" id="L53">        Long userId = getUserId(securityContext);</span>
<span class="nc" id="L54">        Note note = noteService.getNoteById(noteId, userId);</span>
<span class="nc" id="L55">        return Response.ok(toDTO(note)).build();</span>
    }

    @GET
    @Path(&quot;/folder/{folderId}&quot;)
    public Response getNotesByFolder(@PathParam(&quot;folderId&quot;) Long folderId,
                                     @Context SecurityContext securityContext) {
<span class="nc" id="L62">        Long userId = getUserId(securityContext);</span>
<span class="nc" id="L63">        List&lt;Note&gt; notes = noteService.getNotesByFolder(folderId, userId);</span>
<span class="nc" id="L64">        List&lt;NoteDTO&gt; noteDTOs = notes.stream().map(this::toDTO).collect(Collectors.toList());</span>
<span class="nc" id="L65">        return Response.ok(noteDTOs).build();</span>
    }

    @POST
    public Response createNote(@Valid CreateNoteRequest request,
                               @Context SecurityContext securityContext) {
<span class="nc" id="L71">        Long userId = getUserId(securityContext);</span>
<span class="nc" id="L72">        Note note = noteService.createNote(request, userId);</span>
<span class="nc" id="L73">        return Response.status(Response.Status.CREATED).entity(toDTO(note)).build();</span>
    }

    @PUT
    @Path(&quot;/{noteId}&quot;)
    public Response updateNote(@PathParam(&quot;noteId&quot;) Long noteId,
                               @Valid UpdateNoteRequest request,
                               @Context SecurityContext securityContext) {
<span class="nc" id="L81">        Long userId = getUserId(securityContext);</span>
<span class="nc" id="L82">        Note note = noteService.updateNote(noteId, request, userId);</span>
<span class="nc" id="L83">        return Response.ok(toDTO(note)).build();</span>
    }

    @DELETE
    @Path(&quot;/{noteId}&quot;)
    public Response deleteNote(@PathParam(&quot;noteId&quot;) Long noteId,
                               @Context SecurityContext securityContext) {
<span class="nc" id="L90">        Long userId = getUserId(securityContext);</span>
<span class="nc" id="L91">        noteService.deleteNote(noteId, userId);</span>
<span class="nc" id="L92">        return Response.noContent().build();</span>
    }

    @PUT
    @Path(&quot;/{noteId}/move&quot;)
    public Response moveNote(@PathParam(&quot;noteId&quot;) Long noteId,
                             MoveNoteRequest request,
                             @Context SecurityContext securityContext) {
<span class="nc" id="L100">        Long userId = getUserId(securityContext);</span>
<span class="nc" id="L101">        Note note = noteService.moveNoteToFolder(noteId, request.folderId, userId);</span>
<span class="nc" id="L102">        return Response.ok(toDTO(note)).build();</span>
    }

    @POST
    @Path(&quot;/{noteId}/copy&quot;)
    public Response copyNote(@PathParam(&quot;noteId&quot;) Long noteId,
                             @Context SecurityContext securityContext) {
<span class="nc" id="L109">        Long userId = getUserId(securityContext);</span>
<span class="nc" id="L110">        Note copy = noteService.copyNote(noteId, userId);</span>
<span class="nc" id="L111">        return Response.status(Response.Status.CREATED).entity(toDTO(copy)).build();</span>
    }

    @GET
    @Path(&quot;/search&quot;)
    public Response searchNotes(@QueryParam(&quot;q&quot;) String keyword,
                                @Context SecurityContext securityContext) {
<span class="nc" id="L118">        Long userId = getUserId(securityContext);</span>
<span class="nc" id="L119">        List&lt;Note&gt; notes = noteService.searchNotes(keyword, userId);</span>
<span class="nc" id="L120">        List&lt;NoteDTO&gt; noteDTOs = notes.stream().map(this::toDTO).collect(Collectors.toList());</span>
<span class="nc" id="L121">        return Response.ok(noteDTOs).build();</span>
    }

    // Endpoints per versioning
    @GET
    @Path(&quot;/{noteId}/versions&quot;)
    public Response getVersions(@PathParam(&quot;noteId&quot;) Long noteId,
                                @Context SecurityContext securityContext) {
<span class="nc" id="L129">        Long userId = getUserId(securityContext);</span>
<span class="nc" id="L130">        List&lt;NoteVersionDTO&gt; versions = versionService.getNoteVersions(noteId, userId);</span>
<span class="nc" id="L131">        return Response.ok(versions).build();</span>
    }

    @GET
    @Path(&quot;/{noteId}/versions/{versionNumber}&quot;)
    public Response getSpecificVersion(@PathParam(&quot;noteId&quot;) Long noteId,
                                       @PathParam(&quot;versionNumber&quot;) Long versionNumber,
                                       @Context SecurityContext securityContext) {
<span class="nc" id="L139">        Long userId = getUserId(securityContext);</span>
<span class="nc" id="L140">        NoteVersionDTO version = versionService.getSpecificVersion(noteId, versionNumber, userId);</span>
<span class="nc" id="L141">        return Response.ok(version).build();</span>
    }

    @POST
    @Path(&quot;/{noteId}/versions/{versionNumber}/restore&quot;)
    public Response restoreVersion(@PathParam(&quot;noteId&quot;) Long noteId,
                                   @PathParam(&quot;versionNumber&quot;) Long versionNumber,
                                   @Context SecurityContext securityContext) {
<span class="nc" id="L149">        Long userId = getUserId(securityContext);</span>
<span class="nc" id="L150">        Note note = versionService.restoreVersion(noteId, versionNumber, userId);</span>
<span class="nc" id="L151">        return Response.ok(toDTO(note)).build();</span>
    }

    private NoteDTO toDTO(Note note) {
<span class="nc" id="L155">        NoteDTO dto = new NoteDTO();</span>
<span class="nc" id="L156">        dto.id = note.id;</span>
<span class="nc" id="L157">        dto.title = note.title;</span>
<span class="nc" id="L158">        dto.content = note.content;</span>
<span class="nc bnc" id="L159" title="All 2 branches missed.">        dto.ownerId = note.owner != null ? note.owner.id : null;</span>
<span class="nc" id="L160">        dto.ownerUsername = null;</span>
<span class="nc" id="L161">        dto.createdAt = note.createdAt;</span>
<span class="nc" id="L162">        dto.updatedAt = note.updatedAt;</span>
<span class="nc" id="L163">        dto.version = note.version;</span>
<span class="nc" id="L164">        return dto;</span>
    }

    // DTO interno per move request
<span class="nc" id="L168">    public static class MoveNoteRequest {</span>
        public Long folderId;
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>